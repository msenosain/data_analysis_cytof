---
title: "TMA36 CyTOF dataset: Indolent vs. Aggressive"
author: "Mafe Senosain"
date: "`r Sys.Date()`"
output:
    html_document:
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
library(ggplot2)
library(RColorBrewer)
library(gridExtra)
library(reshape2)
library(jcolors)
library(ComplexHeatmap)
knitr::opts_chunk$set(echo = FALSE)
source("/Users/senosam/Documents/Repositories/Research/data_analysis_cytof/R/20_ClustAnnot_functions.R")
source("/Users/senosam/Documents/Repositories/Research/data_analysis_cytof/R/30_DA_functions.R")
source("/Users/senosam/Documents/Repositories/Research/data_analysis_cytof/R/40_DE_functions.R")
```

```{r, echo=FALSE}
# Load data
load("/Users/senosam/Documents/Massion_lab/CyTOF_summary/both/cellclusters.RData")
ref <- ref[-42,] # sample 13376 has been collected twice and will be merged, only one ref is needed
load("/Users/senosam/Documents/Massion_lab/CyTOF_summary/both/percent_pt.RData")
load("/Users/senosam/Documents/Massion_lab/CyTOF_summary/both/protein_correlations.RData")
```

```{r, echo=FALSE}
# Clinical data
CDE <- read.csv(file = '/Users/senosam/Documents/Massion_lab/CyTOF_summary/CDE_TMA36_2021JAN13_SA_MF.csv')
```

```{r, echo=FALSE}
CDE <- CDE[match(ref$pt_ID, CDE$pt_ID),] # Select only pts with CyTOF data
```

```{r, echo=FALSE}

```


# 1. Entire data set

## 1.1 UMAPs 
```{r}
load("/Users/senosam/Documents/Massion_lab/manuscripts/prelim_cytof_adc/data/tumor_samples /UMAPcelltypes_paper2020.RData")
```

```{r, echo=FALSE}
# By density, cluster, patient
#plot_colors
m_ct <- c("#FA0000", "#207BBB", "#00B84C", "#999999")
s_ct <- c("#f0dc78", "#FA0000", "#207BBB", "#00B84C", "#631461", "#966995", "#c9c9c9", "#FF7500" ,"#FF6BBC")
nop1 <- c("#EC7063", "#3498DB")
nop2 <- c("#EC7063", "#3498DB", "grey72")

n <- 71
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
#pie(rep(1,n), col=sample(col_vector, n))


ClusterUMAP_plot(umap_smp, density = T, color_by_cluster = F, color_by_protein = F, pallete = F,
                 plot_clusnames = F, plot_title = 'Density', x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'cell_type_B', plot_clusnames = F, plot_title = 'Cell identity',
                 plot_colors = m_ct, lg_names = levels(umap_smp$cell_type_B),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'subtype_B', plot_clusnames = F, plot_title = 'Cell identity',
                 plot_colors = s_ct, lg_names = levels(as.factor(umap_smp$subtype_B)),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'n_op1', plot_clusnames = F, plot_title = 'Behavior class',
                 plot_colors = nop1, lg_names = levels(umap_smp$n_op1),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'n_op2', plot_clusnames = F, plot_title = 'Behavior class',
                 plot_colors = nop2, lg_names = levels(umap_smp$n_op2),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp, color_by_cluster = F, color_by_protein = F, color_by_continuous = T, pallete = F,
                 cluster_col = 'SILA', plot_clusnames = F, plot_title = 'SILA score',
                 plot_colors = nop2,  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F, plot_colors = col_vector,
                 cluster_col = 'pt_ID', plot_clusnames = F, plot_title = 'Patient ID',
                 lg_names = levels(as.factor(umap_smp$pt_ID)),  x_lim = c(-11,11), y_lim = c(-11,11))

```

```{r, echo=FALSE, fig.width = 10, fig.height = 5}
x <- c(15,20,29:31,34,37,40,44,46,47,50)
ClusterUMAP_plot(umap_smp, color_by_cluster = F, color_by_protein = T, 
                 ft_cols = x, plot_clusnames = F, x_lim = c(-11,11), y_lim = c(-11,11), 
                 nrow_prot = 2, heights_prot = unit(c(2,2), c("in", "in")))
```

### UMAP of Indolent cells only

```{r, echo=FALSE}
k <- which(umap_smp$n_op1 == 'ind')
umap_smp_i <- umap_smp[k,]
ClusterUMAP_plot(umap_smp_i, density = T, color_by_cluster = F, color_by_protein = F, pallete = F,
                 plot_clusnames = F, plot_title = 'Density', x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp_i, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'cell_type_B', plot_clusnames = F, plot_title = 'Cell identity',
                 plot_colors = m_ct, lg_names = levels(umap_smp_i$cell_type_B),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp_i, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'subtype_B', plot_clusnames = F, plot_title = 'Cell identity',
                 plot_colors = s_ct, lg_names = levels(as.factor(umap_smp_i$subtype_B)),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp_i, color_by_cluster = T, color_by_protein = F, pallete = F, plot_colors = col_vector,
                 cluster_col = 'pt_ID', plot_clusnames = F, plot_title = 'Patient ID',
                 lg_names = levels(as.factor(umap_smp_i$pt_ID)),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp_i, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'n_op1', plot_clusnames = F, plot_title = 'Behavior class',
                 plot_colors = c('#3498DB'), lg_names = c('indolent'),  x_lim = c(-11,11), y_lim = c(-11,11))

```

### UMAP of Aggressive cells only
```{r, echo=FALSE}
k <- which(umap_smp$n_op1 == 'agg')
umap_smp_a <- umap_smp[k,]
ClusterUMAP_plot(umap_smp_a, density = T, color_by_cluster = F, color_by_protein = F, pallete = F,
                 plot_clusnames = F, plot_title = 'Density', x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp_a, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'cell_type_B', plot_clusnames = F, plot_title = 'Cell identity',
                 plot_colors = m_ct, lg_names = levels(umap_smp_a$cell_type_B),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp_a, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'subtype_B', plot_clusnames = F, plot_title = 'Cell identity',
                 plot_colors = s_ct, lg_names = levels(as.factor(umap_smp_a$subtype_B)),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp_a, color_by_cluster = T, color_by_protein = F, pallete = F, plot_colors = col_vector,
                 cluster_col = 'pt_ID', plot_clusnames = F, plot_title = 'Patient ID',
                 lg_names = levels(as.factor(umap_smp_a$pt_ID)),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp_a, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'n_op1', plot_clusnames = F, plot_title = 'Behavior class',
                 plot_colors = nop1, lg_names = c('aggressive'),  x_lim = c(-11,11), y_lim = c(-11,11))
```

## 1.2 Barplots of subtypes clusters

## 1.3 Heatmaps by cell type proportion
### 1.3.1 Main cell types
### 1.3.2 All subtypes
### 1.3.3 Stroma + immune subtypes
### 1.3.4 Immune subtypes

## 1.4 Boxplots comparing cell type proportion
### 1.4.1 Main cell types
### 1.4.2 All subtypes

# 2. In depth analysis by cell subtype

## 2.1 Epithelial cancer cells (ECC)
### UMAPs
### Heatmap (median exp per cluster)
### Violin plots (median expression per cluster + distribution)
### Heatmap of proportions (maybe)
### Boxplots comparing cluster proportions (% of sample)
### Boxplots comparing cluster proportions (% of subtype/sample)
### Boxplots comparing protein expression

## 2.2 Endothelial cells

## 2.3 Mesenchymal cells

## 2.4 CD8+ T cells

## 2.5 CD4+ T cells

## 2.6 DN T cells

## 2.7 Myeloid cells

## 2.8 NK cells


# 3. Other visualizations

## 3.1 Protein-protein correlation (co-expression)
### Bulk
### By subtype

## 3.2 Cell type proportions correlations
### Major cell types
### Cell subtypes
### Cell subtypes clusters

## 3.3 Heatmap w/bulk protein expression

## 3.4 Correlation scatter plots (as needed)

