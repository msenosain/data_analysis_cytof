---
title: "Analysis of first 11 tumors"
author: "Mafe Senosain"
date: "1/24/2020"
output:
    html_document:
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
library(ggplot2)
library(RColorBrewer)
library(gridExtra)
library(reshape2)
library(jcolors)
knitr::opts_chunk$set(echo = TRUE)
source("/Users/senosam/Documents/Repositories/Research/data_analysis_cytof/R/20_ClustAnnot_functions.R")
source("/Users/senosam/Documents/Repositories/Research/data_analysis_cytof/R/30_DA_functions.R")
source("/Users/senosam/Documents/Repositories/Research/data_analysis_cytof/R/40_DE_functions.R")
```


```{r, echo=FALSE}
dendrogram_barplot <- function(data, dist_method = 'euclidean', 
    hclust_method = 'ward.D', corr_mat = FALSE, coul, xlabl="Cell type (% of sample)",
    ylabl="Patient ID", legend_p ='none', BPOrderAsDendrogram=T, bp_order,
    cex_names=0.75, cex_axis=0.75, cex_lab=1, cex_sub=1){
    
    # Dendrogram
    if(corr_mat){
        corr_pt <- Hmisc::rcorr(t(as.matrix(data)), type = 'spearman')
        dist_mat <- dist(corr_pt$r, method = dist_method)
    } else {
        dist_mat <- dist(data, method = dist_method)
    }
    hclust_avg <- hclust(dist_mat, method = hclust_method)
    par(mar=c(2,7,4,2), lwd=2, mgp=c(3,1,0), las=1, font.lab=2)
    plot(hclust_avg,cex = 0.8, hang = -1, main = paste0(hclust_method, ' linkage'))
    
    # Barplot
    #coul = coul
    if(BPOrderAsDendrogram){
      data <- data[hclust_avg$order,] #dendrogram order
    }else{
      data <- data[bp_order,]
    }
    
    data <- t(as.matrix(data))
    
    par(mgp=c(1.5,0.25,0), las=1, mar = c(3, 5, 1, 7.5), xpd=TRUE, font.lab=2, lwd=1) # axis label locations
    barplot(data,
            col=coul ,
            border='white',
            horiz=TRUE,
            cex.names = cex_names,
            cex.axis = cex_axis,
            cex.lab = cex_lab,
            #cex.sub = cex_sub,
            legend = FALSE)
    title(xlab=xlabl, mgp = c(1.5, 0.5, 0))
    title(ylab=ylabl,  mgp = c(3, 0.1, 0))
    # legend('topright', legend = rownames(data), fill = coul, ncol = 1, inset=c(-0.3,0),
    #            cex = 0.75) 

}


ClusterUMAP_plot <- function(data, 
                             density = F,
                             color_by_cluster = T, 
                             color_by_protein = F, 
                             cluster_col, ft_cols, 
                             pallete = F,
                             plot_clusnames = F,
                             plot_colors,
                             plot_title,
                             lg_names,
                             x_lim = c(-10,10),
                             y_lim = c(-10,10),
                             nrow_prot = 2,
                             heights_prot = unit(c(1.3,1.3), c("in", "in")),
                             title_size_prot = 10, epi_clus=F){
  
  if(density){
    test <- data[c('UMAP1', 'UMAP2')]
    p_cl <- ggplot(test, aes(x = UMAP1, y = UMAP2)) + 
      geom_point(shape = 20, size = 0.01) + 
      ggtitle(plot_title) +
      theme_bw() +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
            panel.background = element_blank(), axis.line =  element_blank(),
            legend.position = "right",
            legend.title=element_blank(),
            panel.border = element_rect(colour = "black", fill=NA),
            aspect.ratio = 1, axis.text = element_text(colour = 1, size = 10),
            legend.background = element_blank(),
            legend.spacing.y = unit(0, "mm"),
            legend.spacing.x = unit(0, "mm"),
            legend.box.background = element_rect(colour = "black"),
            legend.text = element_text(size = 8),
            plot.title = element_text(size=16, face="bold"),
            legend.key.size = unit(0.5, "cm"),
            legend.key.width = unit(0.5,"cm"),
            axis.title=element_text(size=10)) +
      stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", n=100) +
      #xlim(x_lim) +
      #ylim(y_lim) +
      scale_x_continuous(limits = x_lim, expand = c(0, 0)) +
      scale_y_continuous(limits = y_lim, expand = c(0, 0)) +
      scale_fill_viridis_c(option = 'magma') #https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html
    return(p_cl)
  }
  
  if(color_by_cluster){
    test <- data[c(cluster_col, 'UMAP1', 'UMAP2')]
    test[,cluster_col] <- as.factor(test[,cluster_col])
    
    p_cl <- ggplot(test) + 
      geom_point(aes_string(x='UMAP1', y='UMAP2', colour = test[,cluster_col]), 
                 shape = 19, size = 0.01, alpha = 0.4) +
      ggtitle(plot_title) +
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
            panel.background = element_blank(), axis.line =  element_blank(),
            legend.position = "right",
            legend.title=element_blank(),
            panel.border = element_rect(colour = "black", fill=NA),
            aspect.ratio = 1, axis.text = element_text(colour = 1, size = 10),
            legend.background = element_blank(),
            legend.spacing.y = unit(0, "mm"),
            legend.spacing.x = unit(0, "mm"),
            legend.box.background = element_rect(colour = "black"),
            legend.text = element_text(size = 8),
            plot.title = element_text(size=16, face="bold"),
            legend.key.size = unit(0.5, "cm"),
            legend.key.width = unit(0.5,"cm"),
            axis.title=element_text(size=10)) +
      scale_x_continuous(limits = x_lim, expand = c(0, 0)) +
      scale_y_continuous(limits = y_lim, expand = c(0, 0)) +
      guides(colour = guide_legend(override.aes = list(size=3, alpha=1, pch=15))) #override legend features
    
    if(pallete){
      #p_cl <- p_cl + scale_color_brewer(palette="Set3", labels = lg_names) + scale_color_hue(l=60, c=65)
      p_cl <- p_cl + scale_color_jcolors(palette = 'pal8', labels = lg_names)
    } else {
      p_cl <- p_cl + scale_color_manual(values=plot_colors, labels = lg_names)
    }
    
    if (plot_clusnames){
      edata <- cbind(test$UMAP1, test$UMAP2, cluster_col=test[cluster_col])
      colnames(edata) <- c('x', "y", "z")
      center <- aggregate(cbind(x,y) ~ z, data = edata, median)
      if(epi_clus){
        lb <- sapply(strsplit(as.character(center[,1]), "_"), "[[", 2)
      }else{
          lb <- center[,1]
        }
      p_cl <- p_cl + annotate("text", label = lb, 
                              x=center[,2], y = center[,3], size = 6, colour = "black", fontface = 'bold')
    }
    return(p_cl)
  }
  
  if(color_by_protein){
    data2 <- data[,ft_cols]
    data <- cbind(data2, data[c('UMAP1', 'UMAP2')])
    #data <- data[c(colnames(data)[ft_cols], 'UMAP1', 'UMAP2')]
    test <- melt(data, id= c('UMAP1', 'UMAP2'))
    var_list <- unique(test$variable)
    
    #x <- sapply(strsplit(var_list, "_"), "[[", 2)
    pl <- list()
    for(i in seq_along(var_list)) {
      p <- ggplot(subset(test,test$variable==var_list[i]), aes(x=UMAP1, y=UMAP2, colour = value)) + 
        geom_point(shape = 20, alpha=0.4, size = 0.5) + 
        theme_bw() + 
        ggtitle(sapply(strsplit(as.character(var_list[i]), "_"), "[[", 2)) + 
        scale_colour_gradient(low = "grey72", high = "blue") +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
              panel.background = element_blank(), axis.line =  element_blank(),
              #axis.ticks=element_blank(), 
              axis.title=element_blank(),
              axis.text=element_blank(), aspect.ratio = 1,
              legend.position = "none",
              plot.title = element_text(size=title_size_prot)) +
      scale_x_continuous(limits = x_lim, expand = c(0, 0)) +
      scale_y_continuous(limits = y_lim, expand = c(0, 0))
      
      pl[[i]] <- p
    }
    umap_pl <- grid.arrange(grobs=pl, nrow=nrow_prot, heights=heights_prot)
    return(umap_pl)
  }
}
```

# Cell lines data

```{r, echo=FALSE}
# Load data
load("/Users/senosam/Documents/Massion_lab/manuscripts/prelim_cytof_adc/data/cell_lines/processed_files/mix/mix_celllines_labeled.RData")
big_df$cl_ID <- factor(big_df$cl_ID, levels = c("A549", "H23", "PC9", "H3122", "PBMCs"))
```

## Fig 1. Cell lines validation
```{r}
seed = 65
set.seed(seed)
#print(as.matrix(colnames(big_df)))
col_id <- grep('[(]v[)]', colnames(big_df))
colnames(big_df) <- gsub('[(]v[)]', '', colnames(big_df))
smpl <- denoisingCTF::t_asinh(big_df)

# UMAP
# umap_smp <- umap::umap(smpl[,col_id])
# umap_smp <- as.data.frame(cbind(smpl,
#                                     UMAP1 = umap_smp$layout[,1],
#                                     UMAP2 = umap_smp$layout[,2]))
# save(umap_smp, file = "UMAPcelllines_paper2020.RData")
load("~/Documents/Massion_lab/manuscripts/prelim_cytof_adc/data/cell_lines/processed_files/mix/UMAPcelllines_paper2020.RData")

```

```{r, echo=FALSE}
# By density, cluster, patient
#plot_colors
ct <- c("#EF7E33", "#52A02E", "#D7392E", "#9467BD", "#2977B4")
ClusterUMAP_plot(umap_smp, density = T, color_by_cluster = F, color_by_protein = F, pallete = F,
                 plot_clusnames = F, plot_title = 'Density', x_lim = c(-14,11), y_lim = c(-10,14),
                 plot_colors = ct, lg_names = levels(umap_smp$cl_ID))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'cl_ID', plot_clusnames = F, plot_title = 'Cell identity',
                 plot_colors = ct, lg_names = levels(as.factor(umap_smp$cl_ID)),  
                 x_lim = c(-14,11), y_lim = c(-10,14))

```

```{r, echo=FALSE, fig.width = 6, fig.height = 10}
x <- c(15, 37, 41, 38, 26, 18, 45, 29, 46, 34, 44, 47)

ClusterUMAP_plot(umap_smp, color_by_cluster = F, color_by_protein = T, 
                 ft_cols = x, plot_clusnames = F, x_lim = c(-14,11), y_lim = c(-10,14),
                 nrow_prot = 4, heights_prot = unit(c(2,2,2,2), c("in", "in","in","in")), title_size_prot = 12)

```

```{r echo=FALSE, fig.width = 10, fig.height = 6}

df_hm <- cbind(smpl[,col_id], cluster = as.factor(smpl$cl_ID))

cl_median <-  aggregate(df_hm[,1:(ncol(df_hm)-1)],list(df_hm$cluster), median)
rownames(cl_median) <- cl_median$Group.1
cl_median$Group.1 <- NULL
colnames(cl_median) <- gsub(".*_",  "",colnames(cl_median))
  
library(gplots)
scale_max = max(cl_median)
heat_palette_med <- colorRampPalette(c("black", "yellow","#FAF7C9"))
pairs.breaks_med <- c(seq(0, scale_max/6.6, by = 0.1),
                      seq(scale_max/6.6, scale_max/3.3, by = 0.1),
                      seq(scale_max/3.3, scale_max, by = 0.1))

```

```{r echo=FALSE, fig.width = 12, fig.height = 5}
heatmap.2(as.matrix(cl_median),
          main = "Median protein expression",
          dendrogram = "both",
          Rowv = TRUE,
          Colv = TRUE,
          breaks = pairs.breaks_med,
          revC = FALSE,
          symkey = FALSE,
          symbreaks = FALSE,
          scale = "none",
          cexRow = 1.2,
          cexCol = 1.2,
          key = TRUE,
          col = heat_palette_med,
          trace = "none",
          density.info = 'none',
          sepcolor="#424242",
          margins = c(7,3),
          colsep=1:ncol(cl_median),
          rowsep=1:nrow(cl_median),
          sepwidth=c(0.005,0.005),
          keysize = 0.5,
          key.title = 'Intensity',
          key.xlab= "Arcsinh Transform",
          extrafun = box(lty = "solid"),
          srtCol=90,
          lhei=c(1,1), lwid=c(1,8))
```
## Fig 2. Clustering cell lines

```{r}
# find optimal number of clusters (elbow plot)
# DetermineNumberOfClusters(smpl[,col_id],k_max=45,plot=T,smooth=0.2, iter.max=50, seed = 45, 
#                           ask_ft = F,arcsn_tr = F)
# k-means clustering
set.seed(45)
cl_data <- stats::kmeans(smpl[,col_id], centers = 8, iter.max = 50)$cluster
df_cluster <- cbind(smpl[,col_id], 'cluster'= cl_data, "cl_ID"=smpl$cl_ID, umap_smp[c('UMAP1', 'UMAP2')])

# proyect clusters on UMAP
kl <- c("gray60", "#AAD7AC", "#F9C769", "steelblue1", "#B27CC1", "lightskyblue1", "#F2BFB9", "cornflowerblue")
ClusterUMAP_plot(df_cluster, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'cluster', plot_clusnames = T, plot_title = 'Cluster ID',
                 lg_names = levels(as.factor(df_cluster$cluster)),  
                 x_lim = c(-14,11), y_lim = c(-10,14), plot_colors = kl)
```



```{r echo=FALSE, fig.width = 10, fig.height = 6}

df_hm <- df_cluster[,1:34]

cl_median <-  aggregate(df_hm[,1:33],list(df_hm$cluster), median)
rownames(cl_median) <- cl_median$Group.1
cl_median$Group.1 <- NULL
colnames(cl_median) <- gsub(".*_",  "",colnames(cl_median))
  
library(gplots)
scale_max = max(cl_median)
heat_palette_med <- colorRampPalette(c("black", "yellow","#FAF7C9"))
pairs.breaks_med <- c(seq(0, scale_max/6.6, by = 0.1),
                      seq(scale_max/6.6, scale_max/3.3, by = 0.1),
                      seq(scale_max/3.3, scale_max, by = 0.1))

```

```{r echo=FALSE, fig.width = 12, fig.height = 7}
heatmap.2(as.matrix(cl_median),
          main = "Median protein expression",
          dendrogram = "both",
          Rowv = TRUE,
          Colv = TRUE,
          breaks = pairs.breaks_med,
          revC = FALSE,
          symkey = FALSE,
          symbreaks = FALSE,
          scale = "none",
          cexRow = 1.2,
          cexCol = 1.2,
          key = TRUE,
          col = heat_palette_med,
          trace = "none",
          density.info = 'none',
          sepcolor="#424242",
          margins = c(7,3),
          colsep=1:ncol(cl_median),
          rowsep=1:nrow(cl_median),
          sepwidth=c(0.005,0.005),
          keysize = 0.5,
          key.title = 'Intensity',
          key.xlab= "Arcsinh Transform",
          extrafun = box(lty = "solid"),
          srtCol=90,
          lhei=c(1,1), lwid=c(1,8))
```

```{r}
# barplot
prcnt_by_cl <- ClassAbundanceByPt(data=df_cluster, ptID_col = 'cluster', 
    class_col = 'cl_ID')
prcnt_by_cl <- prcnt_by_cl[order(row.names(prcnt_by_cl)),]
#rownames(prcnt_by_cl) <- paste0(rownames(prcnt_by_pt), '_', ref$CANARY)
prcnt_by_cl <- prcnt_by_cl*100
ct <- c("#EF7E33", "#52A02E", "#D7392E", "#9467BD", "#2977B4")
bp_order <- c(4,8,6,1,5,7,2,3)
dendrogram_barplot(prcnt_by_cl, dist_method = 'euclidean', 
                   hclust_method = 'complete', coul = ct, BPOrderAsDendrogram=F, 
                   bp_order=bp_order, xlabl = "Cell type (% of cluster)" , ylabl = "Cluster ID", 
                   cex_names = 1, cex_axis = 1.2,cex_lab = 0.5) #cex.sub and cex.lab do nothing

```

## Supplementary Fig 1
```{r}
load("~/Documents/Massion_lab/manuscripts/prelim_cytof_adc/data/cell_lines/processed_files/cell_lines_replicates_gated/cell_lines_val_labeled.RData")
#print(as.matrix(colnames(big_df)))
col_id <- grep('[(]v[)]', colnames(big_df_ctl))
#x <- c(15, 37, 41, 38, 26, 18, 45, 29, 46, 34, 44, 47)
colnames(big_df_ctl) <- gsub('[(]v[)]', '', colnames(big_df_ctl))
df <- denoisingCTF::t_asinh(big_df_ctl[,col_id])
colnames(df) <- gsub(" ","", sapply(strsplit(as.character(colnames(df)), "_"), "[[", 2))
df <- cbind(df, cl_ID=big_df_ctl$cl_ID, sample_ID=big_df_ctl$sample_ID)
df <- melt(df)
```

```{r fig.width = 12, fig.height = 12}
# A549
ggplot(df[which(df$cl_ID=='A549'),], aes(x=value, group=sample_ID, color=sample_ID)) +
    geom_density(adjust=1.5) + facet_wrap( ~ variable, scales="free")

# H23
ggplot(df[which(df$cl_ID=='H23'),], aes(x=value, group=sample_ID, color=sample_ID)) +
    geom_density(adjust=1.5) + facet_wrap( ~ variable, scales="free")

# H3122
ggplot(df[which(df$cl_ID=='H3122'),], aes(x=value, group=sample_ID, color=sample_ID)) +
    geom_density(adjust=1.5) + facet_wrap( ~ variable, scales="free")

# Monocytes
ggplot(df[which(df$cl_ID=='Monocytes'),], aes(x=value, group=sample_ID, color=sample_ID)) +
    geom_density(adjust=1.5) + facet_wrap( ~ variable, scales="free")

# PC9
ggplot(df[which(df$cl_ID=='PC9'),], aes(x=value, group=sample_ID, color=sample_ID)) +
    geom_density(adjust=1.5) + facet_wrap( ~ variable, scales="free")

# Tc.cells
ggplot(df[which(df$cl_ID=='Tc.cells'),], aes(x=value, group=sample_ID, color=sample_ID)) +
    geom_density(adjust=1.5) + facet_wrap( ~ variable, scales="free")

# Th.cells
ggplot(df[which(df$cl_ID=='Th.cells'),], aes(x=value, group=sample_ID, color=sample_ID)) +
    geom_density(adjust=1.5) + facet_wrap( ~ variable, scales="free")


```

# Patient samples

```{r, echo=FALSE}
# Load data
load("/Users/senosam/Documents/Massion_lab/CyTOF_summary/woCD90/cellsubtypes.RData")
```

```{r, echo=FALSE}
annot_df <- annot_df[-which(annot_df$CANARY =='I'),]
ref <- ref[-which(ref$CANARY =='I'),]

# Changing un-identified T cells into "Other_immune"
k <- which(annot_df$subtype =='T_cells')
k2 <- which(annot_df$subtype =='NK_cells')

annot_df['subtype'] <- as.character(annot_df$subtype)
annot_df[c(k,k2), 'subtype'] <- 'Other_immune'
annot_df$subtype <- as.factor(annot_df$subtype)

annot_df['subtype4'] <- as.character(annot_df$subtype)
annot_df[which(annot_df$cell_type=='Epithelial'), 'subtype4'] <- 'Epithelial'
annot_df$subtype4 <- as.factor(annot_df$subtype4)
annot_df$subtype4 <- factor(annot_df$subtype4, levels = c("Epithelial", "Endothelial", "Mesenchymal", "Other_immune", "Myeloid", "Tc_cells", "Th_cells"))

# Changing Tc_cells and Th_cells
annot_df$subtype <- as.character(annot_df$subtype)
annot_df$subtype4 <- as.character(annot_df$subtype4)
k <- which(annot_df$subtype =='Tc_cells')
annot_df[k, 'subtype'] <- 'CD8T_cells'
annot_df[k, 'subtype4'] <- 'CD8T_cells'
k <- which(annot_df$subtype =='Th_cells')
annot_df[k, 'subtype'] <- 'CD4T_cells'
annot_df[k, 'subtype4'] <- 'CD4T_cells'
annot_df$subtype <- as.factor(annot_df$subtype)
annot_df$subtype4 <- as.factor(annot_df$subtype4)
annot_df$subtype4 <- factor(annot_df$subtype4, levels = c("Epithelial", "Endothelial", "Mesenchymal", "Other_immune", "Myeloid", "CD8T_cells", "CD4T_cells"))
```


## Fig 3
### Fig 3A - Cell type proyection (UMAP)
```{r, echo=FALSE}
seed = 65
set.seed(seed)
#print(as.matrix(colnames(annot_df)))
# sampling k cells per sample
smpl <- annot_df[1,]
smpl <- smpl[-1,]
k = 4000
pts = unique(annot_df$pt_ID)
for(i in pts){
  x <- dplyr::sample_n(annot_df[which(annot_df$pt_ID %in% i),], size=k, replace=F)
  smpl <- rbind(smpl, x)
}
smpl <- denoisingCTF::t_asinh(smpl)
col_id <- c(15,19,20,29:31,34,37,40,44,46,47,50)

#UMAP
# umap_smp <- umap::umap(smpl[,col_id])
# umap_smp <- as.data.frame(cbind(smpl,
#                                     UMAP1 = umap_smp$layout[,1],
#                                     UMAP2 = umap_smp$layout[,2]))
# save(umap_smp, file = "UMAPcelltypes_paper2020.RData")
load("/Users/senosam/Documents/Massion_lab/manuscripts/prelim_cytof_adc/data/tumor_samples /UMAPcelltypes_paper2020.RData")

```

```{r}
# Changing Tc_cells and Th_cells
umap_smp$subtype <- as.character(umap_smp$subtype)
umap_smp$subtype4 <- as.character(umap_smp$subtype4)
k <- which(umap_smp$subtype =='Tc_cells')
umap_smp[k, 'subtype'] <- 'CD8T_cells'
umap_smp[k, 'subtype4'] <- 'CD8T_cells'
k <- which(umap_smp$subtype =='Th_cells')
umap_smp[k, 'subtype'] <- 'CD4T_cells'
umap_smp[k, 'subtype4'] <- 'CD4T_cells'
umap_smp$subtype <- as.factor(umap_smp$subtype)
umap_smp$subtype4 <- as.factor(umap_smp$subtype4)
umap_smp$subtype4 <- factor(umap_smp$subtype4, levels = c("Epithelial", "Endothelial", "Mesenchymal", "Other_immune", "Myeloid", "CD8T_cells", "CD4T_cells"))


umap_smp['subtype4'] <- as.character(umap_smp$subtype)
umap_smp[which(umap_smp$cell_type=='Epithelial'), 'subtype4'] <- 'ECC'
umap_smp$subtype4 <- as.factor(umap_smp$subtype4)
umap_smp$subtype4 <- factor(umap_smp$subtype4, levels = c("ECC", "Endothelial", "Mesenchymal", "Other_immune", "Myeloid", "CD8T_cells", "CD4T_cells"))

```

```{r, echo=FALSE}
# By density, cluster, patient
#plot_colors
ct <- c("#207BBB", "#FA0000", "#00B84C", '#999999', "#A736A3", '#FF7500', "#FF6BBC")
canary <- c("#3498DB", "#EC7063")
ptidcol <- c("#CD6155", "#EC7063", "#AF7AC5", "#5499C7", "#48C9B0", "#52BE80", "#F4D03F", "#EB984E", "#99A3A4", "#566573")
library(RColorBrewer)

ClusterUMAP_plot(umap_smp, density = T, color_by_cluster = F, color_by_protein = F, pallete = F,
                 plot_clusnames = F, plot_title = 'Density', x_lim = c(-11,11), y_lim = c(-11,11),
                 plot_colors = ct, lg_names = levels(umap_smp$subtype4))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'subtype4', plot_clusnames = F, plot_title = 'Cell identity',
                 plot_colors = ct, lg_names = levels(umap_smp$subtype4),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F, plot_colors = ptidcol,
                 cluster_col = 'pt_ID', plot_clusnames = F, plot_title = 'Patient ID',
                 lg_names = levels(as.factor(umap_smp$pt_ID)),  x_lim = c(-11,11), y_lim = c(-11,11))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'CANARY', plot_clusnames = F, plot_title = 'CANARY',
                 plot_colors = canary, lg_names = c('LPS', 'SPS'),  x_lim = c(-11,11), y_lim = c(-11,11))
```

### Fig 3B - Protein markers in UMAP proyection
```{r, echo=FALSE, fig.width = 10, fig.height = 5}
x <- c(15, 19, 20, 29, 31, 34, 37, 40, 44, 46, 47, 50)
ClusterUMAP_plot(umap_smp, color_by_cluster = F, color_by_protein = T, 
                 ft_cols = x, plot_clusnames = F, x_lim = c(-11,11), y_lim = c(-11,11), 
                 nrow_prot = 2, heights_prot = unit(c(2,2), c("in", "in")))
```


### Fig 3C - Barplot cell types + dendrogram
```{r, echo=FALSE}
prcnt_by_pt <- ClassAbundanceByPt(data=annot_df, ptID_col = 'pt_ID', 
    class_col = 'subtype4')
#rownames(prcnt_by_pt) <- paste0(rownames(prcnt_by_pt), '_', ref$CANARY)
prcnt_by_pt <- prcnt_by_pt*100
prcnt_by_pt <- prcnt_by_pt[,levels(annot_df$subtype4)]

# Dendrograms and barplots (add option for color)
ct <- c("#207BBB", "#FA0000", "#00B84C", '#999999', "#A736A3", '#FF7500', "#FF6BBC")
dendrogram_barplot(prcnt_by_pt, dist_method = 'euclidean', hclust_method = 'ward.D', corr_mat = T, coul = ct)

# Evaluating significance of hclust with pvclust
x <- Hmisc::rcorr(t(as.matrix(prcnt_by_pt)), type = 'spearman')
x1 <- pvclust::pvclust(x$r, method.dist = 'euclidean', method.hclust = 'ward.D')
plot(x1, cex = 0.8, hang = -1)

# save percentages table
# save similarity matrix (pt x pt)
```

### Fig 3D - Correlation plot Immune cells vs Endothelial cells
```{r echo=FALSE, fig.width = 5, fig.height = 5}
prcnt_by_pt <- ClassAbundanceByPt(data=annot_df, ptID_col = 'pt_ID', 
    class_col = 'cell_type')
rownames(prcnt_by_pt) <- paste0(rownames(prcnt_by_pt), '_', ref$CANARY)

prcnt_by_pt <- prcnt_by_pt*100

# Correlation plot
corr_plot(prcnt_by_pt)
```

```{r echo=FALSE, fig.width = 5, fig.height = 3}
ggpubr::ggscatter(prcnt_by_pt, x = 'Endothelial', y = 'Immune',
          add = "reg.line", conf.int = TRUE, combine = TRUE,
          cor.coeff.args = list(method = "spearman", label.x.npc = "left", label.y = 90),
          cor.coef = TRUE, add.params = list(color = 'grey65'),
          xlab = "Endothelial cells %", ylab = 'Immune cells %') +
          ggpubr::font("xy.text", size = 10) +
          ggpubr::font("xlab", size = 12, face = 'bold') +
          ggpubr::font("ylab", size = 12, face = 'bold')+
  theme(aspect.ratio = 0.8)

ggpubr::ggscatter(prcnt_by_pt, x = "Mesenchymal", y = 'Immune',
          add = "reg.line", conf.int = TRUE, combine = TRUE,
          cor.coeff.args = list(method = "spearman", label.x.npc = "left", label.y = 0),
          cor.coef = TRUE, add.params = list(color = 'grey65'),
          xlab = "Mesenchymal cells %", ylab = 'Immune cells %') +
          ggpubr::font("xy.text", size = 10) +
          ggpubr::font("xlab", size = 12, face = 'bold') +
          ggpubr::font("ylab", size = 12, face = 'bold') +
  theme(aspect.ratio = 0.8)

# save correlation table, p values table 
```

## Supplementary info

### S. Figure on cell type abundances G vs P
```{r, echo=FALSE}
# Differential abundance
x <- DA_analysis(annot_df, ref, class_col='subtype4', group_levels=c('G','P'),
     group_col = 'CANARY', ptID_col = 'pt_ID')
x$pvals

prcnt_by_pt <- ClassAbundanceByPt(data=annot_df, ptID_col = 'pt_ID', 
    class_col = 'subtype4')
prcnt_by_pt2 <- ClassAbundanceByPt(data=annot_df, ptID_col = 'pt_ID', 
    class_col = 'cell_type')
rownames(prcnt_by_pt) <- paste0(rownames(prcnt_by_pt), '_', ref$CANARY)
prcnt_by_pt['Immune'] <- prcnt_by_pt2$Immune
prcnt_by_pt <- prcnt_by_pt*100
prcnt_by_pt['pt_ID'] <- ref$pt_ID
prcnt_by_pt['CANARY'] <- as.character(ref$CANARY)
prcnt_by_pt$CANARY[which(prcnt_by_pt$CANARY =='G')] <- 'LPS'
prcnt_by_pt$CANARY[which(prcnt_by_pt$CANARY =='P')] <- 'SPS'
prcnt_by_pt$CANARY <- as.factor(prcnt_by_pt$CANARY)

rs_prcnt <- reshape::melt(prcnt_by_pt)
colnames(rs_prcnt)[4] <- 'Percent'
# ggplot(rs_prcnt, aes(x=CANARY, y=Percent, color = CANARY)) +
#   geom_boxplot() +
  
ggplot(rs_prcnt, aes(x=CANARY, y=Percent, fill = CANARY)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=2) +
  #ylim(0,1)+
  #ggsignif::geom_signif(comparisons = list(c("LPS", "SPS")), 
  #     map_signif_level=TRUE) +
  facet_wrap(~variable, scales='free') +
  theme(plot.title = element_text(hjust = 0.5, size=22))+
  scale_fill_manual(values=canary)
# save tables
```

### S. Figure on protein expression by cell type G vs P
```{r, echo=FALSE}
ref$CANARY <- as.character(ref$CANARY)
ref$CANARY[which(ref$CANARY =='G')] <- 'LPS'
ref$CANARY[which(ref$CANARY =='P')] <- 'SPS'
ref$CANARY <- as.factor(ref$CANARY)
# boxplots
# save tables
med_all <- median_by_pt(annot_df, ref, subset_celltype=F,
    ask_features=F, ft_idxs = c(15, 17:31, 33:35, 37:48, 50, 51), 
    ptID_col = 'pt_ID', groups=c('LPS', 'SPS'))

med_endo <- median_by_pt(annot_df, ref, subset_celltype=T, celltype_col='cell_type',
    celltype_name='Endothelial', ask_features=F, ft_idxs = c(15, 17:31, 33:35, 37:48, 50, 51), 
    ptID_col = 'pt_ID', groups=c('LPS', 'SPS'))

med_epi <- median_by_pt(annot_df, ref, subset_celltype=T, celltype_col='cell_type',
    celltype_name='Epithelial', ask_features=F, ft_idxs = c(15, 17:31, 33:35, 37:48, 50, 51), 
    ptID_col = 'pt_ID', groups=c('LPS', 'SPS'))

med_fibmes <- median_by_pt(annot_df, ref, subset_celltype=T, celltype_col='cell_type',
    celltype_name='Mesenchymal', ask_features=F, ft_idxs = c(15, 17:31, 33:35, 37:48, 50, 51), 
    ptID_col = 'pt_ID', groups=c('LPS', 'SPS'))

med_imm <- median_by_pt(annot_df, ref, subset_celltype=T, celltype_col='cell_type',
    celltype_name='Immune', ask_features=F, ft_idxs = c(15, 17:31, 33:35, 37:48, 50, 51), 
    ptID_col = 'pt_ID', groups=c('LPS', 'SPS'))

med_CD8T <- median_by_pt(annot_df, ref, subset_celltype=T, celltype_col='subtype',
    celltype_name='CD8T_cells', ask_features=F, ft_idxs = c(15, 17:31, 33:35, 37:48, 50, 51), 
    ptID_col = 'pt_ID', groups=c('LPS', 'SPS'))

med_CD4T <- median_by_pt(annot_df, ref, subset_celltype=T, celltype_col='subtype',
    celltype_name='CD4T_cells', ask_features=F, ft_idxs = c(15, 17:31, 33:35, 37:48, 50, 51), 
    ptID_col = 'pt_ID', groups=c('LPS', 'SPS'))

med_mye <- median_by_pt(annot_df, ref, subset_celltype=T, celltype_col='subtype',
    celltype_name='Myeloid', ask_features=F, ft_idxs = c(15, 17:31, 33:35, 37:48, 50, 51), 
    ptID_col = 'pt_ID', groups=c('LPS', 'SPS'))
```

#### All cells
```{r echo=FALSE}
sbst <- reshape::melt(med_all$Med_expression)
#plot(ftimp_rf)

ggplot(sbst, aes(x=CANARY, y=value, fill = CANARY)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=2) +
  ylim(0,10)+
  ggsignif::geom_signif(comparisons = list(c("LPS", "SPS")), 
       map_signif_level=TRUE) +
  facet_wrap(~variable) +
  theme(plot.title = element_text(hjust = 0.5, size=22)) +
  scale_fill_manual(values=canary)

med_all$pvals
```

#### Endothelial cells
```{r echo=FALSE}
sbst <- reshape::melt(med_endo$Med_expression)
#plot(ftimp_rf)
ggplot(sbst, aes(x=CANARY, y=value, fill = CANARY)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=2) +
  ylim(0,10)+
  ggsignif::geom_signif(comparisons = list(c("LPS", "SPS")), 
       map_signif_level=TRUE) +
  facet_wrap(~variable) +
  theme(plot.title = element_text(hjust = 0.5, size=22)) +
  scale_fill_manual(values=canary)

med_endo$pvals
```

#### Fibroblasts/Mesenchymal cells
```{r echo=FALSE}
sbst <- reshape::melt(med_fibmes$Med_expression)
#plot(ftimp_rf)
ggplot(sbst, aes(x=CANARY, y=value, fill = CANARY)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=2) +
  ylim(0,10)+
  ggsignif::geom_signif(comparisons = list(c("LPS", "SPS")), 
       map_signif_level=TRUE) +
  facet_wrap(~variable) +
  theme(plot.title = element_text(hjust = 0.5, size=22)) +
  scale_fill_manual(values=canary)

med_fibmes$pvals
```

#### Immune cells
```{r echo=FALSE}
sbst <- reshape::melt(med_imm$Med_expression)
#plot(ftimp_rf)
ggplot(sbst, aes(x=CANARY, y=value, fill = CANARY)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=2) +
  ylim(0,10)+
  ggsignif::geom_signif(comparisons = list(c("LPS", "SPS")), 
       map_signif_level=TRUE) +
  facet_wrap(~variable) +
  theme(plot.title = element_text(hjust = 0.5, size=22)) +
  scale_fill_manual(values=canary)

med_imm$pvals
```

#### CD8 T cells
```{r echo=FALSE}
sbst <- reshape::melt(med_CD8T$Med_expression)
#plot(ftimp_rf)
ggplot(sbst, aes(x=CANARY, y=value, fill = CANARY)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=2) +
  ylim(0,10)+
  ggsignif::geom_signif(comparisons = list(c("LPS", "SPS")), 
       map_signif_level=TRUE) +
  facet_wrap(~variable) +
  theme(plot.title = element_text(hjust = 0.5, size=22)) +
  scale_fill_manual(values=canary)

med_CD8T$pvals
```

#### CD4 T cells
```{r echo=FALSE}
sbst <- reshape::melt(med_CD4T$Med_expression)
#plot(ftimp_rf)
ggplot(sbst, aes(x=CANARY, y=value, fill = CANARY)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=2) +
  ylim(0,10)+
  ggsignif::geom_signif(comparisons = list(c("LPS", "SPS")), 
       map_signif_level=TRUE) +
  facet_wrap(~variable) +
  theme(plot.title = element_text(hjust = 0.5, size=22)) +
  scale_fill_manual(values=canary)

med_CD4T$pvals
```

#### Myeloid cells
```{r echo=FALSE}
sbst <- reshape::melt(med_mye$Med_expression)
#plot(ftimp_rf)
ggplot(sbst, aes(x=CANARY, y=value, fill = CANARY)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=2) +
  ylim(0,10)+
  ggsignif::geom_signif(comparisons = list(c("LPS", "SPS")), 
       map_signif_level=TRUE) +
  facet_wrap(~variable) +
  theme(plot.title = element_text(hjust = 0.5, size=22)) +
  scale_fill_manual(values=canary)

med_mye$pvals
```

#### Epithelial cells
```{r echo=FALSE}
sbst <- reshape::melt(med_epi$Med_expression)
#plot(ftimp_rf)
ggplot(sbst, aes(x=CANARY, y=value, fill = CANARY)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=2) +
  ylim(0,10)+
  ggsignif::geom_signif(comparisons = list(c("LPS", "SPS")), 
       map_signif_level=TRUE) +
  facet_wrap(~variable) +
  theme(plot.title = element_text(hjust = 0.5, size=22)) +
  scale_fill_manual(values=canary)

med_epi$pvals
```

```{r}
ref_samples <- ref
# Check HLA-DR expression in controls
load("/Users/senosam/Documents/Massion_lab/CyTOF_summary/controls/annotated_controls.RData")
ref_clt <- ref[which(ref$CyTOF_date %in% ref_samples$CyTOF_date),]
annot_df_ctl <- annot_df_ctl[which(annot_df_ctl$CyTOF_date %in% ref_samples$CyTOF_date),]
```

```{r}
ramos <- annot_df_ctl[which(annot_df_ctl$cell_line=='Ramos'),]
a549 <- annot_df_ctl[which(annot_df_ctl$cell_line=='A549'),]
ramos_median <- aggregate(denoisingCTF::t_asinh(ramos[,c(15, 17:31, 33:35, 37:48, 50:51)]), list(ramos[,'CyTOF_date']), median)
a549_median <- aggregate(denoisingCTF::t_asinh(a549[,c(15, 17:31, 33:35, 37:48, 50:51)]), list(a549[,'CyTOF_date']), median)
a549_median['Cell_line'] <- rep('A549', nrow(a549_median))
ramos_median['Cell_line'] <- rep('Ramos', nrow(ramos_median))
ctl_median <- rbind(a549_median, ramos_median)

ggplot(ctl_median, aes(x=Cell_line, y=`174Yb_HLA-DR`, fill = Cell_line)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.8) +
  ylim(0,6)+
  #facet_wrap(~variable) +
  theme(plot.title = element_text(hjust = 0.5, size=22),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14))

summary(ctl_median$`174Yb_HLA-DR`[1:4])
summary(ctl_median$`174Yb_HLA-DR`[5:8])

```

## Fig 4
```{r, echo=FALSE}
sbst <- subset(annot_df, cell_type == 'Epithelial')
sbst$subtype <- factor(sbst$subtype)
sbst$subtype <- factor(sbst$subtype, levels = c(paste0("Epithelial_", 1:10)))
prcnt_by_pt <- ClassAbundanceByPt(data=sbst, ptID_col = 'pt_ID', 
    class_col = 'subtype')
#rownames(prcnt_by_pt) <- paste0(rownames(prcnt_by_pt), '_', ref$CANARY)
prcnt_by_pt <- prcnt_by_pt*100
prcnt_by_pt <- prcnt_by_pt[,levels(sbst$subtype)]
```

### Fig 4A - Epithelial clusters proyection (UMAP)
```{r, echo=FALSE}
seed = 50
set.seed(seed)

# sampling k cells per sample
smpl <- sbst[1,]
smpl <- smpl[-1,]
k = 2000
pts = unique(sbst$pt_ID)
for(i in pts){
  x <- dplyr::sample_n(sbst[which(sbst$pt_ID %in% i),], size=k, replace=T)
  smpl <- rbind(smpl, x)
}
smpl <- denoisingCTF::t_asinh(smpl)
col_id <- c(15,18,19,21:29,31,33,35,37,38,40:43,45,48,50,51)
# UMAP
# umap_smp <- umap::umap(smpl[,col_id])
# umap_smp <- as.data.frame(cbind(smpl,
#                                     UMAP1 = umap_smp$layout[,1],
#                                     UMAP2 = umap_smp$layout[,2]))

# save(umap_smp, file = "UMAPepiclusters_paper2020.RData")
load("/Users/senosam/Documents/Massion_lab/manuscripts/prelim_cytof_adc/data/tumor_samples /UMAPepiclusters_paper2020.RData")
```

```{r}
umap_smp['subtype'] <- gsub('Epithelial', 'ECCc' ,umap_smp$subtype)
umap_smp$subtype <- as.factor(umap_smp$subtype)
umap_smp$subtype <- factor(umap_smp$subtype, levels = c(paste0("ECCc_", 1:10)))
#umap_smp$subtype4 <- factor(umap_smp$subtype4, levels = c("ECC", "Endothelial", "Mesenchymal", "Other_immune", "Myeloid", "Tc_cells", "Th_cells"))
```

```{r, echo=FALSE}
# By density, cluster, patient
#plot_colors
# # 7, 8, 9
# "#85C1E9", "#3498DB", "#2874A6"
# # 1 3 6
# "#F1C40F", "#E67E22", "#D35400"
# # 2 4
# "#1ABC9C", "#16A085"
# # 5 10
# "#27AE60", "#2ECC71"

# epi_cl <- c("#477DBF", "#C0504D", "#9BBB59", "#8064A2", '#4BACC6', "#F79646", "#2C4D75",
#             "#772C2A", '#5F7530', "#4D3B62")
epi_cl <- c("#F1C40F", "#1ABC9C", "#E67E22", "#16A085", "#27AE60", "#D35400", "#85C1E9", "#3498DB", "#2874A6", "#2ECC71")
canary <- c("#3498DB", "#EC7063")
ptidcol <- c("#CD6155", "#EC7063", "#AF7AC5", "#5499C7", "#48C9B0", "#52BE80", "#F4D03F", "#EB984E", "#99A3A4", "#566573")

ClusterUMAP_plot(umap_smp, density = T, color_by_cluster = F, color_by_protein = F, pallete = F,
                 plot_clusnames = F, plot_title = 'Density', x_lim = c(-11,15), y_lim = c(-11,18),
                 lg_names = levels(umap_smp$subtype))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'subtype', plot_clusnames = T, plot_title = 'Cluster ID', epi_clus = T,
                 plot_colors = epi_cl, lg_names = levels(umap_smp$subtype), x_lim = c(-11,15), y_lim = c(-11,18))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'pt_ID', plot_clusnames = F, plot_title = 'Patient ID', plot_colors = ptidcol,
                 lg_names = levels(as.factor(umap_smp$pt_ID)), x_lim = c(-11,15), y_lim = c(-11,18))
ClusterUMAP_plot(umap_smp, color_by_cluster = T, color_by_protein = F, pallete = F,
                 cluster_col = 'CANARY', plot_clusnames = F, plot_title = 'CANARY',
                 plot_colors = canary, lg_names = c('LPS', 'SPS'), c(-11,15), y_lim = c(-11,18))

```

### Fig 4B - Barplot cell types + dendrogram
```{r, echo=FALSE}
dendrogram_barplot(prcnt_by_pt, dist_method = 'euclidean', hclust_method = 'ward.D', corr_mat = T, coul = epi_cl)
# Evaluating significance of hclust with pvclust
x <- Hmisc::rcorr(t(as.matrix(prcnt_by_pt)), type = 'spearman')
x1 <- pvclust::pvclust(x$r, method.dist = 'euclidean', method.hclust = 'ward.D')
plot(x1, cex = 0.8, hang = -1)

# save percentages table
# save similarity matrix (pt x pt)
```

### Fig 4C - Protein markers by cluster heatmap
```{r echo=FALSE, fig.width = 10, fig.height = 6}
df_cluster <- cbind(denoisingCTF::t_asinh(sbst[,col_id]), cluster = sbst$subtype)
df_cluster$cluster <- as.numeric(gsub(".*_",  "",df_cluster$cluster))
df_cluster$`154Sm_CD45` <- NULL
data <- ClusterEval_data(df_cluster, eval_type = 'heatmap')
colnames(data) <- gsub(".*_",  "",colnames(data))
  
library(gplots)
scale_max = max(data)
heat_palette_med <- colorRampPalette(c("black", "yellow","#FAF7C9"))
pairs.breaks_med <- c(seq(0, scale_max/6.6, by = 0.1),
                      seq(scale_max/6.6, scale_max/3.3, by = 0.1),
                      seq(scale_max/3.3, scale_max, by = 0.1))

heatmap.2(data,
          main = "Median protein expression",
          dendrogram = "both",
          Rowv = TRUE,
          Colv = TRUE,
          breaks = pairs.breaks_med,
          revC = FALSE,
          symkey = FALSE,
          symbreaks = FALSE,
          scale = "none",
          cexRow = 1.2,
          cexCol = 1.2,
          key = TRUE,
          col = heat_palette_med,
          trace = "none",
          density.info = 'none',
          sepcolor="#424242",
          margins = c(7,3),
          colsep=1:ncol(data),
          rowsep=1:nrow(data),
          sepwidth=c(0.005,0.005),
          keysize = 1.2,
          key.title = 'Intensity',
          key.xlab= "Arcsinh Transform",
          extrafun = box(lty = "solid"),
          srtCol=90,
          lhei=c(1,4), lwid=c(5,25))

```

### Fig 4D - Correlation plot T cells vs ECCc

```{r echo=FALSE, fig.width = 8, fig.height = 8}
prcnt_by_pt <- ClassAbundanceByPt(data=annot_df, ptID_col = 'pt_ID', 
    class_col = 'subtype')
rownames(prcnt_by_pt) <- paste0(rownames(prcnt_by_pt), '_', ref$CANARY)
prcnt_by_pt <- prcnt_by_pt*100
colnames(prcnt_by_pt) <- gsub('Epithelial', 'ECCc', colnames(prcnt_by_pt))
# Correlation plot
corr_plot(prcnt_by_pt)

```

```{r echo=FALSE, fig.width = 9, fig.height = 3} 
# Scatter plots
ggpubr::ggscatter(prcnt_by_pt, x = "CD4T_cells", y = c('ECCc_7', 'ECCc_8', 'ECCc_9'),
          add = "reg.line", conf.int = TRUE, combine = TRUE, scales='free',
          cor.coef = TRUE, add.params = list(color = 'grey65'), expand = c(0, 0),
          cor.coeff.args = list(method = "spearman", label.x = 2.5, label.y = -0.5, label.size=4),
          xlab = "CD4+ T cells %", ylab = 'ECC %') +
          ggpubr::font("xy.text", size = 10) +
          ggpubr::font("xlab", size = 12, face = 'bold') +
          ggpubr::font("ylab", size = 12, face = 'bold') 
  
ggpubr::ggscatter(prcnt_by_pt, x = "CD8T_cells", y = c('ECCc_7', 'ECCc_8', 'ECCc_9'),
          add = "reg.line", conf.int = TRUE, combine = TRUE, scales='free', face = 'bold',
          cor.coef = TRUE, add.params = list(color = 'grey65'), expand = c(0, 0),
          cor.coeff.args = list(method = "spearman", label.x = 2.5, label.y = -0.5, label.size=4),
          xlab = "CD8+ T cells %", ylab = 'ECC %') +
          ggpubr::font("xy.text", size = 10) +
          ggpubr::font("xlab", size = 12, face = 'bold') +
          ggpubr::font("ylab", size = 12, face = 'bold')
# save correlation table, p values table 
```


# Supplementary info for reviewers

## Validation with TCGA data
```{r, echo=FALSE}
tcga_adc <- read.table(file = '/Users/senosam/Documents/Massion_lab/RNA_seq_otherprojects/shilin\ TCGA/201908_tcgaDataDownload/GDCByTiger/LUAD.rnaseq2.fpkm.Primary_Solid_Tumor.tsv', sep = '\t', header = TRUE)
tcga_adc_clinical <- read.csv(file = '/Users/senosam/Documents/Massion_lab/RNA_seq/shilin\ TCGA/201908_tcgaDataDownload/GDCByTiger/TCGA-LUAD.Clinicl.csv')
```

```{r, echo=FALSE}
# select patients with path stage only below 4
k <- which(!tcga_adc_clinical$tumor_stage %in% c("stage iv", "not reported"))
tcga_adc_clinical <- tcga_adc_clinical[k,]
pts_clin <- tcga_adc_clinical$submitter_id
pts_clin <- gsub('-', '_', pts_clin)
tcga_adc_clinical$submitter_id <- pts_clin

pts <- colnames(tcga_adc)[7:ncol(tcga_adc)]
pts <- sapply(strsplit(pts, ".01$"), "[[", 1)
pts <- gsub('\\.', '_', pts)
colnames(tcga_adc)[7:ncol(tcga_adc)] <- pts
cln <- c(colnames(tcga_adc)[1:6], pts[which(pts %in% pts_clin)])
tcga_adc <- tcga_adc[,cln] 

rownames(tcga_adc_clinical) <- tcga_adc_clinical$submitter_id
tcga_adc_clinical <- tcga_adc_clinical[colnames(tcga_adc)[7:ncol(tcga_adc)],]


# find genes related with HLA-DR
hla_i <- grep('^HLA-D', tcga_adc$Feature_gene_name)
hla_g <- tcga_adc$Feature_gene_name[hla_i]
# create a new df with those genes only
dt_hla <- tcga_adc[hla_i,7:ncol(tcga_adc)]
rownames(dt_hla) <- tcga_adc$Feature_gene_name[hla_i]
```

```{r, echo=FALSE}
# For each gene, divide cohort into high expression/low expression
# kaplan meier curves for all those genes
# https://www.biostars.org/p/344233/
# https://insight.jci.org/articles/view/121387#SEC4
```

### High hla-dr vs low hla-dr association with T cells (xCell deconvolution)
```{r}
# xCell deconvolution TCGA data 
xcell <- read.delim("https://xcell.ucsf.edu/xCell_TCGA_RSEM.txt", row.names = 1)
cn_xc <- sapply(strsplit(colnames(xcell), ".01$"), "[[", 1)
cn_xc <- gsub('\\.', '_', cn_xc)
colnames(xcell) <- cn_xc
xcell <- xcell[,which(colnames(xcell) %in% tcga_adc_clinical$submitter_id)]
```

```{r}
label_by_gene <- function(normalized_data, gene, meta_data, extremes_only=FALSE, cond_name){
    if(extremes_only){
        data_t <- data.frame(t(normalized_data))
        first_q <- quantile(data_t[,gene])[["25%"]]
        third_q <- quantile(data_t[,gene])[["75%"]]
        data_t$Condition <- "normal"
        data_t$Condition[data_t[,gene] < first_q] <- "low"
        data_t$Condition[data_t[,gene] > third_q] <- "high"

    } else {
        data_t <- data.frame(t(normalized_data))
        mid_q <- quantile(data_t[,gene])[["50%"]]
        data_t$Condition <- "low"
        data_t$Condition[data_t[,gene]  > mid_q] <- "high"

    }
    cn <- c(colnames(meta_data), cond_name)
    meta_data <- cbind(meta_data, x=data_t$Condition)
    meta_data$x <- as.factor(meta_data$x)
    colnames(meta_data) <- cn

    meta_data
}

# Labeling the data based on high vs low expression
hla_genes <- gsub('-', '.', rownames(dt_hla))
pdt <- tcga_adc_clinical
for(i in hla_genes){
  pdt <- label_by_gene(log2(dt_hla+1), gene=i, meta_data = pdt, extremes_only=TRUE, cond_name=i)
}
# Selecting cell types of interest
xcell_ct <- rownames(xcell)[c(6,7,11:13)]

# Subsetting a df with the xcell data to be used
x <- t(xcell)
x_clin <- pdt[rownames(x),]
x <- x[,xcell_ct]
x <- cbind(x, x_clin[,70:ncol(x_clin)])
x <- na.omit(x)
x <- reshape2::melt(x)

# Generating summary table
sum_df <- data.frame(matrix(nrow = 0, ncol = 5))
for (i in colnames(x)[grep("H",colnames(x))]){
  for (ii in unique(x$variable)) {
    k <- which(x$variable == ii)
    x_sub <- x[k,]
    high_i <- which(x_sub[,i] == 'high')
    low_i <- which(x_sub[,i] == 'low')
    n_high <- length(high_i)
    n_low <- length(low_i)
    high_med <- median(x_sub[high_i,'value'])
    low_med <- median(x_sub[low_i,'value'])
    pval <- wilcox.test(x_sub[high_i,'value'], x_sub[low_i,'value'])
    sum_df <- rbind(sum_df, c(i, ii, n_high, n_low, high_med, low_med, pval$p.value))
    #cat(high_med, low_med, pval$p.value)
  }
}
colnames(sum_df) <- c('Gene', 'Cell type', 'size.high', 'size.low', 'Median.High', 'Median.Low', 'p.value')
sum_df['p.adjusted'] <- p.adjust(sum_df$p.value, method = "BH")
write.csv(sum_df, file = 'summary_xcellTCGA.csv')
```


### Generating plots
```{r fig.width = 6, fig.height = 3} 
violin_deconv <- function(x, ct, cluster_ID) {
  k <- which(x$variable %in% ct)
  x_sub <- x[k,c(cluster_ID, "variable", "value")]
  k2 <- which(!x_sub[,cluster_ID] == 'normal')
  x_sub <- x_sub[k2,]
  
  ggplot(x_sub, aes_string(x=cluster_ID, y='value', fill=cluster_ID)) + 
    geom_violin(trim=FALSE) +
    geom_boxplot(width=0.1, fill="white") +
    labs(title=NULL,x="Patient group", y = "Enrichment score") +
    scale_fill_brewer(palette="Dark2",name = gsub('\\.', '-', cluster_ID)) +
    ggsignif::geom_signif(comparisons = list(c("low", "high")),   
                map_signif_level=TRUE) +
    facet_wrap(~variable, scales='free')+
    theme_bw()+
    ggtitle(gsub('\\.', '-', cluster_ID))+
    theme(strip.text.x = element_text(size = 12), 
          axis.text.x =element_text(size = 10), 
          axis.text.y =element_text(size = 10),
          axis.title=element_text(size=12),
          plot.title = element_text(size=20, hjust = 0.5, face="italic"),
          legend.position = "none")
    

}
violin_deconv(x, ct=xcell_ct[c(1,4)], cluster_ID = "HLA.DRA")
violin_deconv(x, ct=xcell_ct[c(1,4)], cluster_ID = "HLA.DRB1")


```



# Rectifying clinical data info (latest update)
```{r echo=FALSE, eval = FALSE}
pts <- c('7984','8356','11522','12924','12929','12994','13197','13376','13436','13622')
#pts <- c('7984','8356','11522','12924','12929','12994','13197','13376','13436','13622','11918','12911','13634','14428','14965')
CDE <- read.csv(file = '/Users/senosam/Documents/Massion_lab/CyTOF_summary/CDE_TMA36_2021JAN13_SA.csv')
cols <- c('pt_ID', 'CANARY', 'SILA', 'Age_at_collection','Gender', 'Race', 'Smoking_Status', 'Age_Started', 'Age_Quit', 'Pack_Years', 'Family_History_Cancer_Type', 'Chest_CT_Size', 'Chest_CT_Location', 'X8th_ed_path_stage')
CDE <- CDE[match(pts, CDE$pt_ID),cols]
CDE <- CDE[match(ref$pt_ID, CDE$pt_ID),]
```

```{r echo=FALSE, eval = FALSE, fig.width = 8, fig.height = 8}

prcnt_by_pt <- ClassAbundanceByPt(data=annot_df, ptID_col = 'pt_ID', 
    class_col = 'subtype')
prcnt_by_pt2 <- ClassAbundanceByPt(data=annot_df, ptID_col = 'pt_ID', 
    class_col = 'cell_type')
prcnt_by_pt['Immune'] <- prcnt_by_pt2$Immune
prcnt_by_pt <- prcnt_by_pt*100
prcnt_by_pt['SILA'] <- CDE$SILA
colnames(prcnt_by_pt) <- gsub('Epithelial', 'ECCc', colnames(prcnt_by_pt))

corr_plot(data = prcnt_by_pt)

```

```{r echo=FALSE, eval = FALSE, fig.width = 9, fig.height = 3} 
# Scatter plots
ggpubr::ggscatter(prcnt_by_pt, x = "SILA", y = c('ECCc_7', 'ECCc_8', 'ECCc_9'),
          add = "reg.line", conf.int = TRUE, combine = TRUE, scales='free',
          cor.coef = TRUE, add.params = list(color = 'grey65'), expand = c(0, 0),
          cor.coeff.args = list(method = "spearman", label.x = 0.1, label.y = -0.5, label.size=4),
          xlab = "SILA score", ylab = 'ECC %') +
          ggpubr::font("xy.text", size = 10) +
          ggpubr::font("xlab", size = 12, face = 'bold') +
          ggpubr::font("ylab", size = 12, face = 'bold') 

# save correlation table, p values table 
```

### S. Figure on ECC clusters abundances G vs P
```{r, eval = FALSE, echo = FALSE}
sbst <- subset(annot_df, cell_type == 'Epithelial')
sbst$subtype <- factor(sbst$subtype)
sbst$subtype <- factor(sbst$subtype, levels = c(paste0("Epithelial_", 1:10)))
prcnt_by_pt <- ClassAbundanceByPt(data=sbst, ptID_col = 'pt_ID', 
    class_col = 'subtype')
prcnt_by_pt <- prcnt_by_pt*100
prcnt_by_pt <- prcnt_by_pt[,levels(sbst$subtype)]

ref2 = ref
ref2$CANARY <- as.character(ref2$CANARY)
ref2$CANARY[which(ref2$CANARY =='LPS')] <- 'G'
ref2$CANARY[which(ref2$CANARY =='SPS')] <- 'P'
ref2$CANARY <- as.factor(ref2$CANARY)

# Differential abundance
x <- DA_analysis(sbst, ref2, class_col='subtype', group_levels=c('G','P'),
     group_col = 'CANARY', ptID_col = 'pt_ID')
x$pvals

colnames(prcnt_by_pt) <- gsub('Epithelial', 'ECCc', colnames(prcnt_by_pt))
prcnt_by_pt['pt_ID'] <- ref2$pt_ID
prcnt_by_pt['CANARY'] <- as.character(ref2$CANARY)
prcnt_by_pt$CANARY[which(prcnt_by_pt$CANARY =='G')] <- 'LPS'
prcnt_by_pt$CANARY[which(prcnt_by_pt$CANARY =='P')] <- 'SPS'
prcnt_by_pt$CANARY <- as.factor(prcnt_by_pt$CANARY)

rs_prcnt <- reshape::melt(prcnt_by_pt)
colnames(rs_prcnt)[4] <- 'Percent'
  
ggplot(rs_prcnt, aes(x=CANARY, y=Percent, fill = CANARY)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=2) +
  #ylim(0,1)+
  #ggsignif::geom_signif(comparisons = list(c("LPS", "SPS")), 
  #     map_signif_level=TRUE) +
  facet_wrap(~variable, scales='free') +
  theme(plot.title = element_text(hjust = 0.5, size=22))+
  scale_fill_manual(values=canary)

```

### Fig 5C
```{r}
# import data
firstdist <- read.csv("/Users/senosam/Documents/Massion_lab/manuscripts/prelim_cytof_adc/sergey_rev/sergeyF5C_1stdist.csv")

secdist <- read.csv("/Users/senosam/Documents/Massion_lab/manuscripts/prelim_cytof_adc/sergey_rev/sergeyF5C_2nddist.csv")

```

```{r}
res <- function(dt){
  LPSm <- median(dt$LPS)
  SPSm <- median(na.omit(dt$SPS))
  pv <- wilcox.test(log(dt$LPS), log(na.omit(dt$SPS)))$p.value
  cat('LPS median = ', LPSm, '\n', 'SPS median = ', SPSm, '\n', 'p value = ', pv, '\n')
}

res(firstdist)
res(secdist)
```

```{r}
res <- function(dt){
  LPSm <- mean(dt$LPS)
  SPSm <- mean(na.omit(dt$SPS))
  pv <- t.test(log(dt$LPS), log(na.omit(dt$SPS)))$p.value
  cat('LPS mean = ', LPSm, '\n', 'SPS mean = ', SPSm, '\n', 'p value = ', pv, '\n')
}

res(firstdist)
res(secdist)
```


```{r fig.width = 3, fig.height = 3} 
canary <- c("#3498DB", "#EC7063")  
firstdist <- na.omit(reshape2::melt(firstdist))
ggplot(firstdist, aes(x=variable, y=value, fill = variable)) +
  geom_boxplot() +
  ggsignif::geom_signif(annotations = 'p=0.11', comparisons = list(c("LPS", "SPS")), 
       map_signif_level=TRUE) +
  theme(plot.title = element_text(hjust = 0.5, size=22))+
  scale_fill_manual(values=canary)+
  ylim(0, max(firstdist$value)+30) +
  geom_jitter(shape=19, position=position_jitter(0.15), size=2)+
  theme_bw() +
  labs(title='Distance to 1st \n nearest tumor cell',x=NULL, y = "Distance (pixels)") +
  theme(strip.text.x = element_text(size = 12), 
          axis.text.x =element_text(size = 10), 
          axis.text.y =element_text(size = 10),
          axis.title=element_text(size=12),
          plot.title = element_text(size=13, hjust = 0.5),
          legend.position = "none")
  

secdist <- na.omit(reshape2::melt(secdist))
ggplot(secdist, aes(x=variable, y=value, fill = variable)) +
  geom_boxplot() +
  ggsignif::geom_signif(annotations = 'p=0.19', comparisons = list(c("LPS", "SPS")), 
       map_signif_level=TRUE) +
  theme(plot.title = element_text(hjust = 0.5, size=22))+
  scale_fill_manual(values=canary)+
  ylim(0, max(secdist$value)+50) +
  geom_jitter(shape=19, position=position_jitter(0.15), size=2)+
  theme_bw() +
  labs(title='Distance to 2nd \n nearest tumor cell',x=NULL, y = "Distance (pixels)") +
  theme(strip.text.x = element_text(size = 12), 
          axis.text.x =element_text(size = 10), 
          axis.text.y =element_text(size = 10),
          axis.title=element_text(size=12),
          plot.title = element_text(size=13, hjust = 0.5),
          legend.position = "none")
```
